<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hunger Games Log Viewer</title>
  <style>
    :root {
      --bg: #f7f8fb;
      --surface: #ffffff;
      --surface-muted: #f0f3f8;
      --text: #1f2937;
      --text-muted: #6b7280;
      --border: #d7deea;
      --accent: #0f62fe;
      --danger-bg: #fff1f2;
      --danger-text: #991b1b;
      --separator-bg: #ecf4ff;
      --separator-text: #0b3f87;
      --mention: #1259d6;
      --max-width: 920px;
      --header-height: 68px;
      --controls-height: 64px;
      --radius: 10px;
      --shadow: 0 8px 24px rgba(20, 30, 55, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      overflow-x: hidden;
      background: linear-gradient(180deg, #f7f8fb 0%, #eef3fa 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
      line-height: 1.5;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 30;
      background: rgba(255, 255, 255, 0.96);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(6px);
    }

    .header-inner,
    .controls-inner,
    .content-inner {
      width: min(var(--max-width), 100% - 24px);
      margin: 0 auto;
    }

    .header-inner {
      min-height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
    }

    .title-wrap {
      min-width: 0;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.05rem, 2.6vw, 1.32rem);
      line-height: 1.2;
      letter-spacing: 0.01em;
    }

    .subtitle {
      margin: 4px 0 0;
      font-size: 0.87rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 62vw;
    }

    .controls {
      position: sticky;
      top: var(--header-height);
      z-index: 20;
      border-bottom: 1px solid var(--border);
      background: rgba(240, 243, 248, 0.94);
      backdrop-filter: blur(6px);
    }

    .controls-inner {
      min-height: var(--controls-height);
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
    }

    .search {
      width: 100%;
      min-height: 42px;
      border: 1px solid var(--border);
      background: var(--surface);
      border-radius: var(--radius);
      padding: 0 12px;
      font-size: 0.98rem;
      color: var(--text);
      outline: none;
    }

    .search:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(15, 98, 254, 0.18);
    }

    .counter {
      font-size: 0.87rem;
      color: var(--text-muted);
      min-width: 96px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .btn {
      border: 1px solid #0e50d2;
      background: var(--accent);
      color: #fff;
      border-radius: var(--radius);
      min-height: 42px;
      min-width: 112px;
      padding: 0 14px;
      font-size: 0.94rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, filter 120ms ease;
    }

    .btn:hover {
      filter: brightness(1.03);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    main {
      padding-top: calc(var(--header-height) + var(--controls-height) + 12px);
      padding-bottom: 20px;
    }

    .content-inner {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: clamp(10px, 2.2vw, 18px);
    }

    .status {
      margin: 0 0 8px;
      font-size: 0.88rem;
      color: var(--text-muted);
    }

    .log {
      display: grid;
      gap: 6px;
      align-content: start;
    }

    .line {
      margin: 0;
      padding: 6px 8px;
      border-radius: 8px;
      background: transparent;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      word-break: normal;
      font-size: clamp(0.96rem, 1.8vw, 1rem);
      line-height: 1.58;
    }

    .line.blank {
      padding: 0;
      min-height: 10px;
    }

    .line.separator {
      margin-top: 4px;
      margin-bottom: 3px;
      font-size: clamp(1rem, 1.9vw, 1.08rem);
      font-weight: 700;
      color: var(--separator-text);
      background: var(--separator-bg);
      border-left: 3px solid #96beff;
    }

    .line.death {
      color: var(--danger-text);
      background: var(--danger-bg);
      border-left: 3px solid #fca5a5;
    }

    .line.dialogue {
      font-style: italic;
    }

    .line.mention-start {
      color: var(--mention);
      font-weight: 600;
    }

    .line.hidden {
      display: none;
    }

    .mention-inline {
      color: var(--mention);
      font-weight: 600;
    }

    @media (max-width: 720px) {
      :root {
        --header-height: 62px;
        --controls-height: 58px;
      }

      .header-inner,
      .controls-inner,
      .content-inner {
        width: min(var(--max-width), 100% - 16px);
      }

      .subtitle {
        max-width: 54vw;
      }

      .btn {
        min-width: 92px;
        padding: 0 12px;
      }

      .controls-inner {
        grid-template-columns: 1fr;
      }

      .counter {
        text-align: left;
      }
    }

    @media (min-width: 1300px) {
      :root {
        --max-width: 980px;
      }
    }
  </style>
</head>
<body>
  <header class="top-header" role="banner">
    <div class="header-inner">
      <div class="title-wrap">
        <h1>Hunger Games</h1>
        <p class="subtitle" id="subtitle">Ready to load set1.txt</p>
      </div>
      <button class="btn" id="loadBtn" type="button">Load</button>
    </div>
  </header>

  <section class="controls" aria-label="Log controls">
    <div class="controls-inner">
      <input class="search" id="searchInput" type="search" placeholder="Search events..." autocomplete="off" spellcheck="false" aria-label="Search lines" />
      <div class="counter" id="counter" aria-live="polite">0 / 0 lines</div>
    </div>
  </section>

  <main>
    <div class="content-inner">
      <p class="status" id="status">Load a log file to begin.</p>
      <div class="log" id="log" role="list" aria-label="Hunger Games log entries"></div>
    </div>
  </main>

  <script>
    (function () {
      "use strict";

      var DEFAULT_FILE = "set1.txt";
      var DAY_MARKER_RE = /^(Day\s+\d+|Night\s+\d+|The Feast|Arena Event)\b/i;
      var DEATH_RE = /(\bDEATH\b|\bdies\b|\bkilled\b|\bdrowned\b|\bburned\b|\bsuffocated\b)/i;
      var DIALOGUE_RE = /"[^"]+"/;
      var STARTS_WITH_MENTION_RE = /^@[\w.-]+/;
      var INLINE_MENTION_RE = /(@[\w.-]+)/g;

      var subtitleEl = document.getElementById("subtitle");
      var statusEl = document.getElementById("status");
      var counterEl = document.getElementById("counter");
      var loadBtn = document.getElementById("loadBtn");
      var searchInput = document.getElementById("searchInput");
      var logEl = document.getElementById("log");

      var lineRecords = [];
      var totalCount = 0;
      var currentFile = getFileFromQuery() || DEFAULT_FILE;

      subtitleEl.textContent = "Ready to load " + currentFile;

      loadBtn.addEventListener("click", function () {
        if (loadBtn.disabled) {
          return;
        }
        var requestedFile = window.prompt("Enter a log filename:", currentFile);
        if (requestedFile === null) {
          return;
        }

        requestedFile = requestedFile.trim();
        if (!requestedFile) {
          return;
        }

        currentFile = requestedFile;
        loadFile(currentFile);
      });

      searchInput.addEventListener("input", function () {
        filterLines(searchInput.value);
      });

      loadFile(currentFile);

      function getFileFromQuery() {
        try {
          var params = new URLSearchParams(window.location.search);
          var fileParam = params.get("file");
          if (!fileParam) {
            return "";
          }
          return fileParam.trim();
        } catch (err) {
          return "";
        }
      }

      function setLoadingState(isLoading) {
        loadBtn.disabled = isLoading;
        loadBtn.textContent = isLoading ? "Loading..." : "Load";
      }

      function setStatus(message, isError) {
        statusEl.textContent = message;
        statusEl.style.color = isError ? "#b91c1c" : "";
      }

      function setCounter(visible, total) {
        counterEl.textContent = visible + " / " + total + " lines";
      }

      async function loadFile(fileName) {
        setLoadingState(true);
        setStatus("Loading " + fileName + "...", false);
        subtitleEl.textContent = "Loading " + fileName;

        try {
          var response = await fetch(fileName, { cache: "no-store" });
          if (!response.ok) {
            throw new Error("HTTP " + response.status);
          }

          var text = await response.text();
          renderLines(text);
          updateURLFile(fileName);

          subtitleEl.textContent = "Loaded " + fileName;
          setStatus("Loaded " + fileName + " successfully.", false);

          if (searchInput.value) {
            filterLines(searchInput.value);
          } else {
            setCounter(totalCount, totalCount);
          }
        } catch (error) {
          lineRecords = [];
          totalCount = 0;
          logEl.replaceChildren();
          setCounter(0, 0);
          subtitleEl.textContent = "Unable to load " + fileName;
          setStatus(
            "Could not load " + fileName + ". This is expected when opening via file://. Use GitHub Pages or a local HTTP server.",
            true
          );
        } finally {
          setLoadingState(false);
        }
      }

      function updateURLFile(fileName) {
        try {
          var url = new URL(window.location.href);
          url.searchParams.set("file", fileName);
          window.history.replaceState({}, "", url.toString());
        } catch (err) {
          // Ignore URL update failures; viewer functionality is unaffected.
        }
      }

      function renderLines(rawText) {
        var normalizedText = rawText.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
        var lines = normalizedText.split("\n");

        totalCount = lines.length;
        lineRecords = new Array(totalCount);

        var fragment = document.createDocumentFragment();

        for (var i = 0; i < lines.length; i += 1) {
          var lineText = lines[i];
          var entry = document.createElement("p");

          entry.className = "line";
          entry.setAttribute("role", "listitem");

          var trimmed = lineText.trim();
          if (trimmed.length === 0) {
            entry.classList.add("blank");
            entry.setAttribute("aria-hidden", "true");
          } else {
            applySemanticClasses(entry, lineText);
            appendLineWithMentions(entry, lineText);
          }

          fragment.appendChild(entry);
          lineRecords[i] = {
            text: lineText,
            lower: lineText.toLowerCase(),
            element: entry
          };
        }

        logEl.replaceChildren(fragment);
      }

      function applySemanticClasses(el, lineText) {
        if (DAY_MARKER_RE.test(lineText)) {
          el.classList.add("separator");
        }
        if (DEATH_RE.test(lineText)) {
          el.classList.add("death");
        }
        if (DIALOGUE_RE.test(lineText)) {
          el.classList.add("dialogue");
        }
        if (STARTS_WITH_MENTION_RE.test(lineText)) {
          el.classList.add("mention-start");
        }
      }

      function appendLineWithMentions(el, lineText) {
        var last = 0;
        INLINE_MENTION_RE.lastIndex = 0;

        while (true) {
          var match = INLINE_MENTION_RE.exec(lineText);
          if (!match) {
            break;
          }

          if (match.index > last) {
            el.appendChild(document.createTextNode(lineText.slice(last, match.index)));
          }

          var mention = document.createElement("span");
          mention.className = "mention-inline";
          mention.textContent = match[0];
          el.appendChild(mention);

          last = match.index + match[0].length;
        }

        if (last < lineText.length || lineText.length === 0) {
          el.appendChild(document.createTextNode(lineText.slice(last)));
        }
      }

      function filterLines(query) {
        if (!lineRecords.length) {
          setCounter(0, totalCount);
          return;
        }

        var q = query.trim().toLowerCase();
        var visibleCount = 0;

        if (!q) {
          for (var i = 0; i < lineRecords.length; i += 1) {
            lineRecords[i].element.classList.remove("hidden");
          }
          setCounter(totalCount, totalCount);
          return;
        }

        for (var j = 0; j < lineRecords.length; j += 1) {
          var rec = lineRecords[j];
          var isMatch = rec.lower.indexOf(q) !== -1;
          if (isMatch) {
            rec.element.classList.remove("hidden");
            visibleCount += 1;
          } else {
            rec.element.classList.add("hidden");
          }
        }

        setCounter(visibleCount, totalCount);
      }
    })();
  </script>
</body>
</html>
